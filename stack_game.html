<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>è¾¦å…¬å®¤ç–Šç–Šæ¨‚</title>
    <style>
      body {
        margin: 0;
        background: #1a1a2e;
        overflow: hidden;
        font-family: "PingFang TC", sans-serif;
        touch-action: none;
      }
      canvas {
        display: block;
      }
      #ui {
        position: absolute;
        top: 30px;
        width: 100%;
        text-align: center;
        color: #fff;
        pointer-events: none;
        z-index: 10;
      }
      #score {
        font-size: 70px;
        font-weight: 900;
        margin: 0;
        line-height: 1;
      }
      #high-score {
        font-size: 16px;
        color: #ffce00;
        margin-top: 5px;
      }
      #msg {
        font-size: 18px;
        color: #00d2ff;
        margin-top: 10px;
        letter-spacing: 2px;
      }

      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 10, 30, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 100;
      }
      .rank-badge {
        background: #ff4757;
        padding: 5px 15px;
        border-radius: 5px;
        font-size: 14px;
        margin-bottom: 10px;
      }
      h1 {
        margin: 10px 0;
        font-size: 2.5rem;
      }
      button {
        padding: 15px 60px;
        font-size: 1.2rem;
        cursor: pointer;
        background: #00d2ff;
        border: none;
        border-radius: 50px;
        color: #fff;
        box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <div id="score">0</div>
      <div id="high-score">BEST: 0</div>
      <div id="msg">æŒ‰ç•«é¢é–‹å§‹å †ç–Š</div>
    </div>

    <div id="overlay">
      <div class="rank-badge">OFFICE CHALLENGE</div>
      <h1>è¾¦å…¬å®¤ç–Šç–Šæ¨‚</h1>
      <p>ç›®æ¨™ï¼šæˆç‚ºäººä¸Šäºº (ç–Šé 50 å±¤)</p>
      <button onclick="init()">é€²å…¥è¾¦å…¬å®¤</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const scoreEl = document.getElementById("score");
      const highEl = document.getElementById("high-score");
      const msgEl = document.getElementById("msg");
      const overlay = document.getElementById("overlay");

      let blocks = [],
        debris = [];
      let gameState = "START";
      let speed = 2.5,
        cameraY = 0,
        screenShake = 0;
      let currentBlock = {};
      let perfectCount = 0; // ç”¨æ–¼éŸ³èª¿éå¢

      // åˆå§‹åŒ–æœ€é«˜ç´€éŒ„
      let highScore = localStorage.getItem("officeStackBest") || 0;
      highEl.innerText = `BEST: ${highScore}`;

      // --- éŸ³æ•ˆå¼•æ“ ---
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playTone(freq, type = "sine", duration = 0.1, volume = 0.1) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + duration,
        );
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
      }

      function init() {
        if (audioCtx.state === "suspended") audioCtx.resume();
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        blocks = [
          {
            x: (canvas.width - 200) / 2,
            y: canvas.height - 150,
            width: 200,
            color: 200,
          },
        ];
        debris = [];
        scoreEl.innerText = "0";
        speed = 2.5;
        cameraY = 0;
        perfectCount = 0;
        newBlock();
        gameState = "PLAYING";
        overlay.style.display = "none";
        animate();
      }

      function newBlock() {
        const last = blocks[blocks.length - 1];
        currentBlock = {
          x: 0,
          y: last.y - 45,
          width: last.width,
          direction: 1,
          color: 200 + ((blocks.length * 15) % 360),
        };
      }

      function animate() {
        if (gameState === "START") return;

        // ç•«é¢éœ‡å‹•èˆ‡ç›¸æ©Ÿ
        let sx = (Math.random() - 0.5) * screenShake,
          sy = (Math.random() - 0.5) * screenShake;
        screenShake *= 0.9;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const targetCam = (blocks.length - 4) * 45;
        cameraY += (targetCam - cameraY) * 0.1;

        ctx.save();
        ctx.translate(sx, cameraY + sy);

        // ç•«æ‰è½ç¢ç‰‡
        debris.forEach((d, i) => {
          d.y += d.vy;
          d.vy += 0.6;
          d.opacity -= 0.03;
          ctx.fillStyle = `hsla(${d.color}, 70%, 50%, ${d.opacity})`;
          ctx.fillRect(d.x, d.y, d.width, 43);
          if (d.opacity <= 0) debris.splice(i, 1);
        });

        // ç•«å·²ç–Šå¡Š
        blocks.forEach((b, i) => {
          ctx.fillStyle = `hsl(${b.color}, 70%, 60%)`;
          ctx.fillRect(b.x, b.y, b.width, 43);
          if (b.perfect) {
            ctx.strokeStyle = "#fff";
            ctx.strokeRect(b.x, b.y, b.width, 43);
          }
        });

        // ç•«ç§»å‹•å¡Š
        if (gameState === "PLAYING") {
          currentBlock.x += speed * currentBlock.direction;
          if (
            currentBlock.x + currentBlock.width > canvas.width ||
            currentBlock.x < 0
          )
            currentBlock.direction *= -1;
          ctx.fillStyle = `hsl(${currentBlock.color}, 70%, 60%)`;
          ctx.fillRect(currentBlock.x, currentBlock.y, currentBlock.width, 43);
        }

        ctx.restore();
        requestAnimationFrame(animate);
      }

      function handleStack() {
        if (gameState !== "PLAYING") return;
        const last = blocks[blocks.length - 1];
        const diff = currentBlock.x - last.x;

        if (Math.abs(diff) >= currentBlock.width) {
          gameOver();
          return;
        }

        if (Math.abs(diff) < 8) {
          // Perfect!
          currentBlock.x = last.x;
          currentBlock.perfect = true;
          perfectCount++;
          msgEl.innerText = "PERFECT!! +" + perfectCount;
          playTone(400 + perfectCount * 50, "triangle", 0.2); // éŸ³èª¿è¶Šä¾†è¶Šé«˜
          screenShake = 5;
        } else {
          perfectCount = 0;
          // è¨ˆç®—åˆ‡é™¤
          let dWidth = Math.abs(diff);
          let dX =
            diff > 0
              ? currentBlock.x + (currentBlock.width - diff)
              : currentBlock.x;
          debris.push({
            x: dX,
            y: currentBlock.y,
            width: dWidth,
            color: currentBlock.color,
            vy: 2,
            opacity: 1,
          });

          if (diff > 0) currentBlock.width -= diff;
          else {
            currentBlock.width += diff;
            currentBlock.x = last.x;
          }

          msgEl.innerText = "OK!";
          playTone(200, "square", 0.1);
        }

        blocks.push({ ...currentBlock });
        scoreEl.innerText = blocks.length - 1;
        speed = Math.min(speed + 0.12, 8);
        newBlock();
        if (navigator.vibrate) navigator.vibrate(20);
      }

      function gameOver() {
        gameState = "OVER";
        playTone(100, "sawtooth", 0.5, 0.2); // å¤±æ•—éŸ³æ•ˆ

        const score = blocks.length - 1;

        // æ›´æ–°æœ€é«˜ç´€éŒ„
        if (score > highScore) {
          highScore = score;
          localStorage.setItem("officeStackBest", score);
          highEl.innerText = `BEST: ${highScore} (NEW!)`;
        }

        // --- 10 éšé ­éŠœé‚è¼¯ (æ¯ 5 å±¤ä¸€éš) ---
        const ranks = [
          { limit: 5, name: "åœ°åŸºæ¿æ¨¡å·¥ ğŸ§±", color: "#94a3b8" },
          { limit: 10, name: "é‹¼ç­‹é‹¼éª¨å£« ğŸ—ï¸", color: "#64748b" },
          { limit: 15, name: "å¤–ç‰†æ‹‰çš®å¸« ğŸ¢", color: "#00d084" },
          { limit: 20, name: "å®¤å…§è£ä¿®é•· ğŸ ", color: "#0693e3" },
          { limit: 25, name: "å¤§æ¨“ç‰©æ¥­ç®¡ç† ğŸ”‘", color: "#8b5cf6" },
          { limit: 30, name: "é–‹ç™¼éƒ¨ç¶“ç† ğŸ“ˆ", color: "#f59e0b" },
          { limit: 35, name: "å»ºè¨­å…¬å¸è‘£äº‹ ğŸ‘”", color: "#ef4444" },
          { limit: 40, name: "éƒ½å¸‚è¨ˆç•«å°ˆå®¶ ğŸ—ºï¸", color: "#ec4899" },
          { limit: 45, name: "åœ°ç”¢é¾é ­å¤§äº¨ ğŸ’°", color: "#facc15" },
          { limit: 999, name: "ç¯‰å¤¢å¤©ç©ºä¹‹åŸ â˜ï¸", color: "#ffffff" },
        ];

        // è‡ªå‹•æŠ“å–å°æ‡‰çš„é ­éŠœ
        const myRank =
          ranks.find((r) => score <= r.limit) || ranks[ranks.length - 1];

        // é¡¯ç¤ºçµç®—ç•«é¢
        overlay.style.display = "flex";
        // ç¨å¾®å»¶é²è®“é€æ˜åº¦å‹•ç•«ç”Ÿæ•ˆ
        setTimeout(() => (overlay.style.opacity = "1"), 10);

        overlay.innerHTML = `
        <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);">
            <h1 style="margin:0; color:#ff4757;">æŒ‘æˆ°çµæŸ</h1>
            <div style="font-size: 4rem; font-weight: 900; margin: 10px 0;">${score} <span style="font-size:1rem; font-weight:normal;">å±¤</span></div>
            
            <div style="background: ${myRank.color}; color: ${score >= 46 ? "#000" : "#fff"}; padding: 10px 20px; border-radius: 10px; font-size: 1.4rem; font-weight: bold; margin-bottom: 25px;">
                ${myRank.name}
            </div>
            
            <button onclick="init()" style="background: #00d2ff; color: white; padding: 15px 40px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,210,255,0.4);">
                å†è“‹ä¸€æ£Ÿï¼
            </button>
        </div>
    `;
      }

      window.addEventListener("touchstart", (e) => {
        e.preventDefault();
        handleStack();
      });
      window.addEventListener("mousedown", (e) => {
        if (e.button === 0) handleStack();
      });
      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    </script>
  </body>
</html>
