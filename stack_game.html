<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>è¾¦å…¬å®¤ç–Šç–Šæ¨‚</title>
    <style>
      body {
        margin: 0;
        background: #1a1a2e;
        overflow: hidden;
        font-family: "PingFang TC", sans-serif;
        /* é˜²æ­¢æ‰‹æ©Ÿé•·æŒ‰é¸å–æˆ–å½ˆå‡ºé¸å–® */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        touch-action: none;
      }
      canvas {
        display: block;
      }
      #ui {
        position: absolute;
        top: 30px;
        width: 100%;
        text-align: center;
        color: #fff;
        pointer-events: none; /* è®“é»æ“Šç©¿é€ UI å±¤ */
        z-index: 10;
      }
      #score {
        font-size: 70px;
        font-weight: 900;
        margin: 0;
        line-height: 1;
      }
      #high-score {
        font-size: 16px;
        color: #ffce00;
        margin-top: 5px;
      }
      #msg {
        font-size: 18px;
        color: #00d2ff;
        margin-top: 10px;
        letter-spacing: 2px;
      }

      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 10, 30, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 100;
      }
      .rank-badge {
        background: #ff4757;
        padding: 5px 15px;
        border-radius: 5px;
        font-size: 14px;
        margin-bottom: 10px;
      }
      h1 {
        margin: 10px 0;
        font-size: 2.5rem;
      }
      button {
        padding: 15px 60px;
        font-size: 1.2rem;
        cursor: pointer;
        background: #00d2ff;
        border: none;
        border-radius: 50px;
        color: #fff;
        box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        font-weight: bold;
        /* ç¢ºä¿æŒ‰éˆ•å¯ä»¥æ¥æ”¶é»æ“Š */
        pointer-events: auto; 
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <div id="score">0</div>
      <div id="high-score">BEST: 0</div>
      <div id="msg">æŒ‰ç•«é¢é–‹å§‹å †ç–Š</div>
    </div>

    <div id="overlay">
      <div class="rank-badge">OFFICE CHALLENGE</div>
      <h1>è¾¦å…¬å®¤ç–Šç–Šæ¨‚</h1>
      <p>ç›®æ¨™ï¼šæˆç‚ºäººä¸Šäºº (ç–Šé 50 å±¤)</p>
      <button id="startBtn">é€²å…¥è¾¦å…¬å®¤</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const scoreEl = document.getElementById("score");
      const highEl = document.getElementById("high-score");
      const msgEl = document.getElementById("msg");
      const overlay = document.getElementById("overlay");
      const startBtn = document.getElementById("startBtn");

      let blocks = [],
        debris = [];
      let gameState = "START";
      let speed = 2.5,
        cameraY = 0,
        screenShake = 0;
      let currentBlock = {};
      let perfectCount = 0;

      let highScore = localStorage.getItem("officeStackBest") || 0;
      highEl.innerText = `BEST: ${highScore}`;

      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playTone(freq, type = "sine", duration = 0.1, volume = 0.1) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
      }

      function init() {
        if (audioCtx.state === "suspended") audioCtx.resume();
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        blocks = [{
          x: (canvas.width - 200) / 2,
          y: canvas.height - 150,
          width: 200,
          color: 200,
        }];
        debris = [];
        scoreEl.innerText = "0";
        speed = 2.5;
        cameraY = 0;
        perfectCount = 0;
        newBlock();
        gameState = "PLAYING";
        overlay.style.display = "none";
        overlay.style.opacity = "0";
        animate();
      }

      // ç¶å®šæŒ‰éˆ•é»æ“Š (ä½¿ç”¨ pointerdown ç¢ºä¿æ‰‹æ©Ÿéˆæ•åº¦)
      startBtn.addEventListener('pointerdown', (e) => {
        e.stopPropagation();
        init();
      });

      function newBlock() {
        const last = blocks[blocks.length - 1];
        currentBlock = {
          x: 0,
          y: last.y - 45,
          width: last.width,
          direction: 1,
          color: 200 + ((blocks.length * 15) % 360),
        };
      }

      function animate() {
        if (gameState === "START") return;

        let sx = (Math.random() - 0.5) * screenShake,
          sy = (Math.random() - 0.5) * screenShake;
        screenShake *= 0.9;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const targetCam = (blocks.length - 4) * 45;
        cameraY += (targetCam - cameraY) * 0.1;

        ctx.save();
        ctx.translate(sx, cameraY + sy);

        debris.forEach((d, i) => {
          d.y += d.vy;
          d.vy += 0.6;
          d.opacity -= 0.03;
          ctx.fillStyle = `hsla(${d.color}, 70%, 50%, ${d.opacity})`;
          ctx.fillRect(d.x, d.y, d.width, 43);
          if (d.opacity <= 0) debris.splice(i, 1);
        });

        blocks.forEach((b) => {
          ctx.fillStyle = `hsl(${b.color}, 70%, 60%)`;
          ctx.fillRect(b.x, b.y, b.width, 43);
          if (b.perfect) {
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.strokeRect(b.x, b.y, b.width, 43);
          }
        });

        if (gameState === "PLAYING") {
          currentBlock.x += speed * currentBlock.direction;
          if (currentBlock.x + currentBlock.width > canvas.width || currentBlock.x < 0)
            currentBlock.direction *= -1;
          ctx.fillStyle = `hsl(${currentBlock.color}, 70%, 60%)`;
          ctx.fillRect(currentBlock.x, currentBlock.y, currentBlock.width, 43);
        }

        ctx.restore();
        requestAnimationFrame(animate);
      }

      function handleStack() {
        if (gameState !== "PLAYING") return;
        const last = blocks[blocks.length - 1];
        const diff = currentBlock.x - last.x;

        if (Math.abs(diff) >= currentBlock.width) {
          gameOver();
          return;
        }

        if (Math.abs(diff) < 10) { // ç¨å¾®æ”¾å¯¬ Perfect åˆ¤å®šåˆ° 10px
          currentBlock.x = last.x;
          currentBlock.perfect = true;
          perfectCount++;
          msgEl.innerText = "PERFECT!! +" + perfectCount;
          playTone(400 + perfectCount * 50, "triangle", 0.2);
          screenShake = 5;
        } else {
          perfectCount = 0;
          let dWidth = Math.abs(diff);
          let dX = diff > 0 ? currentBlock.x + (currentBlock.width - diff) : currentBlock.x;
          debris.push({
            x: dX, y: currentBlock.y, width: dWidth,
            color: currentBlock.color, vy: 2, opacity: 1,
          });

          if (diff > 0) currentBlock.width -= diff;
          else {
            currentBlock.width += diff;
            currentBlock.x = last.x;
          }
          msgEl.innerText = "OK!";
          playTone(200, "square", 0.1);
        }

        blocks.push({ ...currentBlock });
        scoreEl.innerText = blocks.length - 1;
        speed = Math.min(speed + 0.12, 8);
        newBlock();
        if (navigator.vibrate) navigator.vibrate(20);
      }

      function gameOver() {
        gameState = "OVER";
        playTone(100, "sawtooth", 0.5, 0.2);
        const score = blocks.length - 1;

        if (score > highScore) {
          highScore = score;
          localStorage.setItem("officeStackBest", score);
          highEl.innerText = `BEST: ${highScore} (NEW!)`;
        }

        const ranks = [
          { limit: 5, name: "åœ°åŸºæ¿æ¨¡å·¥ ğŸ§±", color: "#94a3b8" },
          { limit: 10, name: "é‹¼ç­‹é‹¼éª¨å£« ğŸ—ï¸", color: "#64748b" },
          { limit: 25, name: "å¤§æ¨“ç‰©æ¥­ç®¡ç† ğŸ”‘", color: "#8b5cf6" },
          { limit: 45, name: "åœ°ç”¢é¾é ­å¤§äº¨ ğŸ’°", color: "#facc15" },
          { limit: 999, name: "ç¯‰å¤¢å¤©ç©ºä¹‹åŸ â˜ï¸", color: "#ffffff" },
        ];

        const myRank = ranks.find((r) => score <= r.limit) || ranks[ranks.length - 1];

        overlay.style.display = "flex";
        setTimeout(() => (overlay.style.opacity = "1"), 10);
        overlay.innerHTML = `
          <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); pointer-events: auto;">
              <h1 style="margin:0; color:#ff4757;">æŒ‘æˆ°çµæŸ</h1>
              <div style="font-size: 4rem; font-weight: 900; margin: 10px 0;">${score} <span style="font-size:1rem; font-weight:normal;">å±¤</span></div>
              <div style="background: ${myRank.color}; color: #000; padding: 10px 20px; border-radius: 10px; font-size: 1.4rem; font-weight: bold; margin-bottom: 25px;">
                  ${myRank.name}
              </div>
              <button id="retryBtn" style="background: #00d2ff; color: white; padding: 15px 40px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                  å†è“‹ä¸€æ£Ÿï¼
              </button>
          </div>
        `;
        
        // é‡æ–°ç¶å®šé‡æ–°é–‹å§‹æŒ‰éˆ•
        document.getElementById("retryBtn").addEventListener('pointerdown', (e) => {
          e.stopPropagation();
          init();
        });
      }

      // --- æ ¸å¿ƒä¿®æ­£ï¼šçµ±ä¸€ç›£è½å™¨ ---
      window.addEventListener("pointerdown", (e) => {
        // å¦‚æœæ˜¯åœ¨éŠæˆ²ç‹€æ…‹ï¼Œä¸”æ²’é»åˆ°æŒ‰éˆ•ï¼Œæ‰è§¸ç™¼ç–Šç£š
        if (gameState === "PLAYING" && e.target.tagName !== "BUTTON") {
          handleStack();
        }
      }, { passive: false });

      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    </script>
  </body>
</html>