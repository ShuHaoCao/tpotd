<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>值班排班表系統 - 行動優化版</title>
    <style>
        :root {
            --border-gray: #dadce0;
            --text-main: #3c4043;
            --text-light: #70757a;
            --holiday-bg: #e2f9e1;
            --holiday-text: #1e8e3e;
            --work-bg: #e8f0fe;
            --work-text: #1a73e8;
            --today-red: #d93025;
            --staff-highlight: #fef7e0;
            --staff-text: #b06000;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: #fff; padding: 10px; color: var(--text-main); margin: 0; }

        /* 控制列佈局 - 手機版改為垂直堆疊或自動換行 */
        .controls {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap; /* 寬度不足時自動換行 */
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }
        
        .staff-selector-container {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 下拉選單在手機上更易點擊 */
        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-gray);
            font-size: 14px;
            background: white;
        }

        /* 日曆容器 - 加入橫向捲動保護 */
        .calendar-wrapper {
            width: 100%;
            overflow-x: auto; /* 手機版若太窄可左右滑動 */
            -webkit-overflow-scrolling: touch;
        }

        .calendar-container {
            min-width: 600px; /* 確保日曆至少有 600px 寬，不會擠扁 */
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #f1f3f4; }
        .day-label { padding: 10px 5px; text-align: center; font-size: 13px; font-weight: bold; color: var(--text-light); border-bottom: 1px solid var(--border-gray); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        
        .day-cell { 
            min-height: 100px; /* 改為最小高度，讓內容可撐開 */
            border-right: 1px solid var(--border-gray); 
            border-bottom: 1px solid var(--border-gray); 
            padding: 4px; 
        }
        .day-cell:nth-child(7n) { border-right: none; }

        .date-number { text-align: right; font-size: 13px; margin-bottom: 4px; }
        .is-today .date-number span {
            background: var(--today-red);
            color: white;
            display: inline-block;
            width: 22px; height: 22px; line-height: 22px;
            border-radius: 50%; text-align: center;
        }

        /* 班別標籤行動化 */
        .duty-tag {
            font-size: 11px; /* 縮小字體 */
            padding: 3px 4px;
            margin-top: 3px;
            border-radius: 4px;
            background: var(--staff-highlight);
            color: var(--staff-text);
            border: 1px solid #ffe1a0;
            display: block;
            word-break: break-all; /* 防止長文字撐破格子 */
            text-align: center;
        }

        .other-month { background-color: #fafafa; }

        /* 手機版專用調整 */
        @media (max-width: 600px) {
            .staff-selector-container {
                margin-left: 0;
                width: 100%; /* 手機版人員選單佔滿整行 */
            }
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .day-cell { min-height: 80px; }
        }
    </style>
</head>
<body>

<div class="controls">
    <div style="display: flex; gap: 8px;">
        <select id="yearSelect"></select>
        <select id="monthSelect"></select>
        <button onclick="renderToday()" style="padding: 8px 12px; cursor: pointer;">今天</button>
    </div>

    <div class="staff-selector-container">
        <label for="staffSelect" style="font-size: 14px; white-space: nowrap;">值班人員：</label>
        <select id="staffSelect" style="flex-grow: 1;">
            <option value="">-- 請選擇 --</option>
        </select>
    </div>
</div>

<div class="calendar-wrapper">
    <div class="calendar-container">
        <div class="calendar-header" id="weekdayHeader"></div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
</div>

<script>
    let scheduleData = {};
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const staffSelect = document.getElementById('staffSelect');
    const gridEl = document.getElementById('calendarGrid');
    const headerEl = document.getElementById('weekdayHeader');

    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
    const now = new Date();

    async function init() {
        weekdays.forEach(d => headerEl.innerHTML += `<div class="day-label">${d}</div>`);
        
        for (let y = 2025; y <= 2027; y++) yearSelect.options.add(new Option(`${y}年`, y));
        for (let m = 0; m < 12; m++) monthSelect.options.add(new Option(`${m + 1}月`, m));
        
        yearSelect.value = now.getFullYear();
        monthSelect.value = now.getMonth();

        try {
            const response = await fetch('schedule_data.json');
            scheduleData = await response.json();
            populateStaff(scheduleData);
        } catch (error) {
            console.error("JSON讀取失敗", error);
        }

        [yearSelect, monthSelect, staffSelect].forEach(el => {
            el.onchange = () => renderCalendar();
        });

        renderCalendar();
    }

    function populateStaff(data) {
        let names = new Set();
        Object.keys(data).forEach(dateKey => {
            if(dateKey === "lastUpdated") return;
            Object.values(data[dateKey]).forEach(name => {
                if(name && name !== "-" && name !== "") names.add(name);
            });
        });
        Array.from(names).sort().forEach(name => {
            staffSelect.options.add(new Option(name, name));
        });
    }

    function renderToday() {
        yearSelect.value = now.getFullYear();
        monthSelect.value = now.getMonth();
        renderCalendar();
    }

    function renderCalendar() {
        const y = parseInt(yearSelect.value);
        const m = parseInt(monthSelect.value);
        const selectedStaff = staffSelect.value;
        gridEl.innerHTML = '';
        
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) {
            gridEl.innerHTML += `<div class="day-cell other-month"></div>`;
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const isToday = (y === now.getFullYear() && m === now.getMonth() && d === now.getDate());
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            
            let dutyInfo = "";
            if (selectedStaff && scheduleData[dateStr]) {
                const dayData = scheduleData[dateStr];
                let shifts = Object.keys(dayData).filter(key => dayData[key] === selectedStaff);
                if (shifts.length > 0) {
                    dutyInfo = shifts.map(s => `<span class="duty-tag">${s}</span>`).join('');
                }
            }

            gridEl.innerHTML += `
                <div class="day-cell ${isToday ? 'is-today' : ''}">
                    <div class="date-number"><span>${d}</span></div>
                    ${dutyInfo}
                </div>
            `;
        }
    }

    init();
</script>

</body>
</html>